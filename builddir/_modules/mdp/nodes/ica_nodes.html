

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mdp.nodes.ica_nodes &mdash; Modular toolkit for Data Processing (MDP)</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Modular toolkit for Data Processing (MDP)" href="../../../index.html"/>
        <link rel="up" title="mdp.nodes" href="../nodes.html"/> 
<meta name="viewport" content="width=740" />


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo_animation.gif" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_cite_mdp.html">How to cite MDP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contact.html">Contact</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MDP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mdp.html">mdp</a> &raquo;</li>
        
          <li><a href="../nodes.html">mdp.nodes</a> &raquo;</li>
        
      <li>mdp.nodes.ica_nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mdp.nodes.ica_nodes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">past.utils</span> <span class="k">import</span> <span class="n">old_div</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">mdp</span>
<span class="kn">from</span> <span class="nn">.isfa_nodes</span> <span class="k">import</span> <span class="n">ISFANode</span>
<span class="n">numx</span><span class="p">,</span> <span class="n">numx_rand</span><span class="p">,</span> <span class="n">numx_linalg</span> <span class="o">=</span> <span class="n">mdp</span><span class="o">.</span><span class="n">numx</span><span class="p">,</span> <span class="n">mdp</span><span class="o">.</span><span class="n">numx_rand</span><span class="p">,</span> <span class="n">mdp</span><span class="o">.</span><span class="n">numx_linalg</span>

<span class="n">utils</span> <span class="o">=</span> <span class="n">mdp</span><span class="o">.</span><span class="n">utils</span>
<span class="n">mult</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mult</span>

<div class="viewcode-block" id="ProjectMatrixMixin"><a class="viewcode-back" href="../../../mdp/mdp.nodes.ica_nodes.html#mdp.nodes.ProjectMatrixMixin">[docs]</a><span class="k">class</span> <span class="nc">ProjectMatrixMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin class to be inherited by all ICA-like algorithms&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_projmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transposed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the projection matrix.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_if_training_stop_training</span><span class="p">()</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">get_projmatrix</span><span class="p">(</span><span class="n">transposed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="k">if</span> <span class="n">transposed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">T</span>

    <span class="k">def</span> <span class="nf">get_recmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transposed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the back-projection matrix (i.e. the reconstruction matrix).</span>
<span class="sd">        Note that if the unknown sources are white, this is a good</span>
<span class="sd">        approximation of the mixing matrix (up to a permutation matrix).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_if_training_stop_training</span><span class="p">()</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">get_recmatrix</span><span class="p">(</span><span class="n">transposed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="k">if</span> <span class="n">transposed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">T</span></div>

<span class="k">class</span> <span class="nc">ICANode</span><span class="p">(</span><span class="n">mdp</span><span class="o">.</span><span class="n">Cumulator</span><span class="p">,</span> <span class="n">mdp</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">ProjectMatrixMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ICANode is a general class to handle different batch-mode algorithm for</span>
<span class="sd">    Independent Component Analysis. More information about ICA can be found</span>
<span class="sd">    among others in</span>
<span class="sd">    Hyvarinen A., Karhunen J., Oja E. (2001). Independent Component Analysis,</span>
<span class="sd">    Wiley.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">whitened</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">white_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">white_parm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">input_dim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input arguments:</span>

<span class="sd">        whitened -- Set whitened is True if input data are already whitened.</span>
<span class="sd">                    Otherwise the node will whiten the data itself.</span>

<span class="sd">        white_comp -- If whitened is False, you can set &#39;white_comp&#39; to the</span>
<span class="sd">                      number of whitened components to keep during the</span>
<span class="sd">                      calculation (i.e., the input dimensions are reduced to</span>
<span class="sd">                      white_comp by keeping the components of largest variance).</span>

<span class="sd">        white_parm -- a dictionary with additional parameters for whitening.</span>
<span class="sd">                      It is passed directly to the WhiteningNode constructor.</span>
<span class="sd">                      Ex: white_parm = { &#39;svd&#39; : True }</span>

<span class="sd">        limit -- convergence threshold.</span>

<span class="sd">        telescope -- If telescope == True, use Telescope mode: Instead of</span>
<span class="sd">          using all input data in a single batch try larger and larger chunks</span>
<span class="sd">          of the input data until convergence is achieved. This should lead to</span>
<span class="sd">          significantly faster convergence for stationary statistics. This mode</span>
<span class="sd">          has not been thoroughly tested and must be considered beta.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">telescope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span> <span class="o">=</span> <span class="n">whitened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">white_comp</span> <span class="o">=</span> <span class="n">white_comp</span>
        <span class="k">if</span> <span class="n">white_parm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white_parm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white_parm</span> <span class="o">=</span> <span class="n">white_parm</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ICANode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_input_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_dim</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_stop_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whiten data if needed and call the &#39;core&#39; routine to perform ICA.</span>
<span class="sd">           Take care of telescope-mode if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ICANode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_stop_training</span><span class="p">()</span>

        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>

        <span class="c1"># ?? rewrite as a 2-phases node</span>
        <span class="c1"># whiten if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_comp</span>
            <span class="n">white</span> <span class="o">=</span> <span class="n">mdp</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">WhiteningNode</span><span class="p">(</span><span class="n">output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_comp</span><span class="p">,</span>
                                            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">white_parm</span><span class="p">)</span>
            <span class="n">white</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">white</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white</span> <span class="o">=</span> <span class="n">white</span>

        <span class="c1"># if output_dim not set, set it now</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># call &#39;core&#39; in telescope mode if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">:</span>
            <span class="n">minpow</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="o">*</span><span class="mi">10</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">maxpow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="n">numx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">numx</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">tel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minpow</span><span class="p">,</span> <span class="n">maxpow</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">tel</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--</span><span class="se">\n</span><span class="s2">Using </span><span class="si">%d</span><span class="s2"> inputs&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
                <span class="n">convergence</span> <span class="o">=</span> <span class="n">core</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">if</span> <span class="n">convergence</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">convergence</span> <span class="o">=</span> <span class="n">core</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Convergence criterium: &quot;</span><span class="p">,</span> <span class="n">convergence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>

    <span class="k">def</span> <span class="nf">core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is the core routine of the ICANode. Each subclass must</span>
<span class="sd">        define this function to return the achieved convergence value.</span>
<span class="sd">        This function is also responsible for setting the ICA filters</span>
<span class="sd">        matrix self.filters.</span>
<span class="sd">        Note that the matrix self.filters is applied to the right of the</span>
<span class="sd">        matrix containing input data. This is the transposed of the matrix</span>
<span class="sd">        defining the linear transformation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># self.filters is applied to the right of the</span>
        <span class="c1"># matrix containing input data. This is the transposed of the matrix</span>
        <span class="c1"># defining the linear transformation.</span>
        <span class="k">return</span> <span class="n">mult</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">CuBICANode</span><span class="p">(</span><span class="n">ICANode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Independent Component Analysis using the CuBICA algorithm.</span>
<span class="sd">    Note that CuBICA is a batch-algorithm, which means that it needs</span>
<span class="sd">    all input data before it can start and compute the ICs.  The</span>
<span class="sd">    algorithm is here given as a Node for convenience, but it actually</span>
<span class="sd">    accumulates all inputs it receives. Remember that to avoid running</span>
<span class="sd">    out of memory when you have many components and many time samples.</span>

<span class="sd">    As an alternative to this batch mode you might consider the telescope</span>
<span class="sd">    mode (see the docs of the ``__init__`` method).</span>

<span class="sd">    Reference:</span>
<span class="sd">    Blaschke, T. and Wiskott, L. (2003).</span>
<span class="sd">    CuBICA: Independent Component Analysis by Simultaneous Third- and</span>
<span class="sd">    Fourth-Order Cumulant Diagonalization.</span>
<span class="sd">    IEEE Transactions on Signal Processing, 52(5), pp. 1250-1256.</span>

<span class="sd">    **Internal variables of interest**</span>

<span class="sd">      ``self.white``</span>
<span class="sd">          The whitening node used for preprocessing.</span>

<span class="sd">      ``self.filters``</span>
<span class="sd">          The ICA filters matrix (this is the transposed of the</span>
<span class="sd">          projection matrix after whitening).</span>

<span class="sd">      ``self.convergence``</span>
<span class="sd">          The value of the convergence threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># keep track of maximum angle of rotation</span>
        <span class="c1"># angles vary in the range [-pi, +pi]</span>
        <span class="c1"># put here -2pi &lt; -pi &lt; +pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxangle</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">numx</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>

        <span class="c1"># we need to copy to avoid overwriting during rotation.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># convergence criterium == maxangle</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tlen</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># some constants</span>
        <span class="n">ct_c34</span> <span class="o">=</span> <span class="mf">0.0625</span>
        <span class="n">ct_s34</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="n">ct_c44</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mi">384</span><span class="p">)</span>
        <span class="n">ct_s44</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mi">96</span><span class="p">)</span>

        <span class="c1"># initial transposed rotation matrix == identity matrix</span>
        <span class="n">Qt</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># maximum number of sweeps through all possible pairs of signals</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">round</span><span class="p">(</span><span class="n">numx</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">comp</span><span class="p">)))</span>

        <span class="c1"># start sweeping</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">maxangle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">comp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
                    <span class="n">u1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="n">u2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">sq1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                    <span class="n">sq2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>

                    <span class="c1"># calculate the cumulants of 3rd and 4th order.</span>
                    <span class="n">C111</span>  <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq1</span><span class="p">,</span> <span class="n">u1</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C112</span>  <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq1</span><span class="p">,</span> <span class="n">u2</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C122</span>  <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq2</span><span class="p">,</span> <span class="n">u1</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C222</span>  <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq2</span><span class="p">,</span> <span class="n">u2</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C1111</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq1</span><span class="p">,</span> <span class="n">sq1</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span>
                    <span class="n">C1112</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq1</span><span class="o">*</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C1122</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq1</span><span class="p">,</span> <span class="n">sq2</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
                    <span class="n">C1222</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq2</span><span class="o">*</span><span class="n">u2</span><span class="p">,</span> <span class="n">u1</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">C2222</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">sq2</span><span class="p">,</span> <span class="n">sq2</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span>

                    <span class="n">c_34</span> <span class="o">=</span> <span class="n">ct_c34</span> <span class="o">*</span> <span class="p">(</span>    <span class="p">(</span><span class="n">C111</span><span class="o">*</span><span class="n">C111</span><span class="o">+</span><span class="n">C222</span><span class="o">*</span><span class="n">C222</span><span class="p">)</span><span class="o">-</span>
                                      <span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="n">C112</span><span class="o">*</span><span class="n">C112</span><span class="o">+</span><span class="n">C122</span><span class="o">*</span><span class="n">C122</span><span class="p">)</span><span class="o">-</span>
                                      <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">C111</span><span class="o">*</span><span class="n">C122</span><span class="o">+</span><span class="n">C112</span><span class="o">*</span><span class="n">C222</span><span class="p">)</span>  <span class="p">)</span>
                    <span class="n">s_34</span> <span class="o">=</span> <span class="n">ct_s34</span> <span class="o">*</span> <span class="p">(</span>     <span class="n">C111</span><span class="o">*</span><span class="n">C112</span><span class="o">-</span><span class="n">C122</span><span class="o">*</span><span class="n">C222</span>   <span class="p">)</span>
                    <span class="n">c_44</span> <span class="o">=</span> <span class="n">ct_c44</span> <span class="o">*</span><span class="p">(</span>  <span class="mf">7.</span><span class="o">*</span><span class="p">(</span><span class="n">C1111</span><span class="o">*</span><span class="n">C1111</span><span class="o">+</span><span class="n">C2222</span><span class="o">*</span><span class="n">C2222</span><span class="p">)</span><span class="o">-</span>
                                     <span class="mf">16.</span><span class="o">*</span><span class="p">(</span><span class="n">C1112</span><span class="o">*</span><span class="n">C1112</span><span class="o">+</span><span class="n">C1222</span><span class="o">*</span><span class="n">C1222</span><span class="p">)</span><span class="o">-</span>
                                     <span class="mf">12.</span><span class="o">*</span><span class="p">(</span><span class="n">C1111</span><span class="o">*</span><span class="n">C1122</span><span class="o">+</span><span class="n">C1122</span><span class="o">*</span><span class="n">C2222</span><span class="p">)</span><span class="o">-</span>
                                     <span class="mf">36.</span><span class="o">*</span><span class="p">(</span><span class="n">C1122</span><span class="o">*</span><span class="n">C1122</span><span class="p">)</span><span class="o">-</span>
                                     <span class="mf">32.</span><span class="o">*</span><span class="p">(</span><span class="n">C1112</span><span class="o">*</span><span class="n">C1222</span><span class="p">)</span><span class="o">-</span>
                                      <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">C1111</span><span class="o">*</span><span class="n">C2222</span><span class="p">)</span>              <span class="p">)</span>
                    <span class="n">s_44</span> <span class="o">=</span> <span class="n">ct_s44</span> <span class="o">*</span><span class="p">(</span>  <span class="mf">7.</span><span class="o">*</span><span class="p">(</span><span class="n">C1111</span><span class="o">*</span><span class="n">C1112</span><span class="o">-</span><span class="n">C1222</span><span class="o">*</span><span class="n">C2222</span><span class="p">)</span><span class="o">+</span>
                                      <span class="mf">6.</span><span class="o">*</span><span class="p">(</span><span class="n">C1112</span><span class="o">*</span><span class="n">C1122</span><span class="o">-</span><span class="n">C1122</span><span class="o">*</span><span class="n">C1222</span><span class="p">)</span><span class="o">+</span>
                                                <span class="p">(</span><span class="n">C1111</span><span class="o">*</span><span class="n">C1222</span><span class="o">-</span><span class="n">C1112</span><span class="o">*</span><span class="n">C2222</span><span class="p">)</span>  <span class="p">)</span>

                    <span class="c1"># rotation angle that maximize the contrast function</span>
                    <span class="n">phi_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">numx</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s_34</span><span class="o">+</span><span class="n">s_44</span><span class="p">,</span> <span class="n">c_34</span><span class="o">+</span><span class="n">c_44</span><span class="p">)</span>

                    <span class="c1"># get the new rotation matrix.</span>
                    <span class="c1"># Using the function rotate with angle &#39;phi&#39; on</span>
                    <span class="c1"># a transformation matrix corresponds to the</span>
                    <span class="c1"># right-multiplication by a rotation matrix</span>
                    <span class="c1"># with angle &#39;-phi&#39;.</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">Qt</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

                    <span class="c1"># rotate input data</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

                    <span class="c1"># keep track of maximum angle of rotation</span>
                    <span class="n">maxangle</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxangle</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phi_max</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">maxangle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxangle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maxangle</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sweeps: &quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">Qt</span>

        <span class="c1"># return the convergence criterium</span>
        <span class="k">return</span> <span class="n">maxangle</span>

<span class="k">class</span> <span class="nc">FastICANode</span><span class="p">(</span><span class="n">ICANode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Independent Component Analysis using the FastICA algorithm.</span>
<span class="sd">    Note that FastICA is a batch-algorithm. This means that it needs</span>
<span class="sd">    all input data before it can start and compute the ICs.</span>
<span class="sd">    The algorithm is here given as a Node for convenience, but it</span>
<span class="sd">    actually accumulates all inputs it receives. Remember that to avoid</span>
<span class="sd">    running out of memory when you have many components and many time samples.</span>

<span class="sd">    FastICA does not support the telescope mode (the convergence</span>
<span class="sd">    criterium is not robust in telescope mode).</span>

<span class="sd">    Reference:</span>
<span class="sd">    Aapo Hyvarinen (1999).</span>
<span class="sd">    Fast and Robust Fixed-Point Algorithms for Independent Component Analysis</span>
<span class="sd">    IEEE Transactions on Neural Networks, 10(3):626-634.</span>

<span class="sd">    **Internal variables of interest**</span>

<span class="sd">      ``self.white``</span>
<span class="sd">          The whitening node used for preprocessing.</span>

<span class="sd">      ``self.filters``</span>
<span class="sd">          The ICA filters matrix (this is the transposed of the</span>
<span class="sd">          projection matrix after whitening).</span>

<span class="sd">      ``self.convergence``</span>
<span class="sd">          The value of the convergence threshold.</span>

<span class="sd">    History:</span>

<span class="sd">    - 1.4.1998 created for Matlab by Jarmo Hurri, Hugo Gavert, Jaakko Sarela,</span>
<span class="sd">      and Aapo Hyvarinen</span>
<span class="sd">    - 7.3.2003  modified for Python by Thomas Wendler</span>
<span class="sd">    - 3.6.2004  rewritten and adapted for scipy and MDP by MDP&#39;s authors</span>
<span class="sd">    - 25.5.2005 now independent from scipy. Requires Numeric or numarray</span>
<span class="sd">    - 26.6.2006 converted to numpy</span>
<span class="sd">    - 14.9.2007 updated to Matlab version 2.5</span>
<span class="sd">    - 26.6.2012 added ability to run two stages of optimization [PK]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">approach</span> <span class="o">=</span> <span class="s1">&#39;defl&#39;</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="s1">&#39;pow3&#39;</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">fine_g</span> <span class="o">=</span> <span class="s1">&#39;pow3&#39;</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fine_tanh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fine_gaus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">max_it</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">max_it_fine</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                 <span class="n">failures</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">coarse_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>  <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">whitened</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">white_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">white_parm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">input_dim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input arguments:</span>

<span class="sd">        General:</span>

<span class="sd">        whitened -- Set whitened == True if input data are already whitened.</span>
<span class="sd">                    Otherwise the node will whiten the data itself</span>

<span class="sd">        white_comp -- If whitened == False, you can set &#39;white_comp&#39; to the</span>
<span class="sd">                      number of whitened components to keep during the</span>
<span class="sd">                      calculation (i.e., the input dimensions are reduced to</span>
<span class="sd">                      white_comp by keeping the components of largest variance).</span>

<span class="sd">        white_parm -- a dictionary with additional parameters for whitening.</span>
<span class="sd">                      It is passed directly to the WhiteningNode constructor.</span>
<span class="sd">                      Ex: white_parm = { &#39;svd&#39; : True }</span>

<span class="sd">        limit -- convergence threshold.</span>

<span class="sd">        Specific for FastICA:</span>

<span class="sd">        approach  -- Approach to use. Possible values are:</span>
<span class="sd">                                          &#39;defl&#39; --&gt; deflation</span>
<span class="sd">                                          &#39;symm&#39; --&gt; symmetric</span>

<span class="sd">               g  -- Nonlinearity to use. Possible values are:</span>
<span class="sd">                                          &#39;pow3&#39; --&gt; x^3</span>
<span class="sd">                                          &#39;tanh&#39; --&gt; tanh(fine_tanh*x)</span>
<span class="sd">                                          &#39;gaus&#39; --&gt; x*exp(-fine_gaus*x^2/2)</span>
<span class="sd">                                          &#39;skew&#39; --&gt; x^2 (for skewed signals)</span>

<span class="sd">           fine_g -- Nonlinearity for fine tuning. Possible values</span>
<span class="sd">                     are the same as for &#39;g&#39;. Set it to None to disable fine</span>
<span class="sd">                     tuning.</span>

<span class="sd">               mu -- Step size. If mu != 1, a stabilization procedure is used:</span>
<span class="sd">                     the value of mu can momentarily be halved if the algorithm</span>
<span class="sd">                     is stuck between two points (this is called a stroke).</span>
<span class="sd">                     Also if there is no convergence before half of the maximum</span>
<span class="sd">                     number of iterations has been reached then mu will be halved</span>
<span class="sd">                     for the rest of the rounds.</span>

<span class="sd">      sample_size -- Percentage of samples used in one iteration. If</span>
<span class="sd">                     sample_size &lt; 1, samples are chosen in random order.</span>

<span class="sd">     coarse_limit -- initial convergence threshold, to switch to</span>
<span class="sd">                     fine_g function (i.e. linear to non-linear) even</span>
<span class="sd">                     before reaching the limit and final tuning. Set</span>
<span class="sd">                     it to a value higher than limit to be in effect.</span>

<span class="sd">        fine_tanh -- parameter for &#39;tanh&#39; nonlinearity</span>
<span class="sd">        fine_gaus -- parameter for &#39;gaus&#39; nonlinearity</span>

<span class="sd">            guess -- initial guess for the mixing matrix (ignored if None)</span>

<span class="sd">           max_it -- maximum number of iterations</span>

<span class="sd">      max_it_fine -- maximum number of iterations for fine tuning</span>

<span class="sd">         failures -- maximum number of failures to allow in deflation mode</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FastICANode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">whitened</span><span class="p">,</span>
                                          <span class="n">white_comp</span><span class="p">,</span> <span class="n">white_parm</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span>
                                          <span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">approach</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;defl&#39;</span><span class="p">,</span> <span class="s1">&#39;symm&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">approach</span> <span class="o">=</span> <span class="n">approach</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> approach method not known&#39;</span> <span class="o">%</span> <span class="n">approach</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pow3&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="s1">&#39;gaus&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> nonlinearity function not known&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fine_g</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pow3&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="s1">&#39;gaus&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fine_g</span> <span class="o">=</span> <span class="n">fine_g</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> nonlinearity function not known&#39;</span> <span class="o">%</span> <span class="n">fine_g</span>
            <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sample_size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="s1">&#39;0&lt;sample_size&lt;1, </span><span class="si">%f</span><span class="s1"> given&#39;</span> <span class="o">%</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stabilization</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">!=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine_tanh</span> <span class="o">=</span> <span class="n">fine_tanh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine_gaus</span> <span class="o">=</span> <span class="n">fine_gaus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_it</span> <span class="o">=</span> <span class="n">max_it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_it_fine</span> <span class="o">=</span> <span class="n">max_it_fine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_limit</span> <span class="o">=</span> <span class="n">coarse_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failures</span> <span class="o">=</span> <span class="n">failures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess</span> <span class="o">=</span> <span class="n">guess</span>

<div class="viewcode-block" id="FastICANode._get_rsamples"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.FastICANode._get_rsamples">[docs]</a>    <span class="k">def</span> <span class="nf">_get_rsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">tlen</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numx_rand</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">tlen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># this is a more or less line per line translation of the original</span>
        <span class="c1"># matlab code.</span>
        <span class="c1"># Everything could be done better and more efficiently.</span>
        <span class="c1"># I just had no time at the moment to do it.</span>
        <span class="c1"># The logic behind the used_g hell is beyond my understanding :-)))</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># casted constants</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tlen</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Default values and initial definitions</span>
        <span class="n">fine_tanh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_tanh</span>
        <span class="n">fine_gaus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_gaus</span>
        <span class="n">approach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">approach</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span>
        <span class="n">fine_g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_g</span>
        <span class="n">stabilization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stabilization</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Take random orthonormal initial vectors.</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">random_rot</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use user supplied mixing matrix</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refcast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guess</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
                <span class="n">guess</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">get_recmatrix</span><span class="p">(</span><span class="n">transposed</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="n">coarse_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_limit</span>
        <span class="n">max_it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_it</span>
        <span class="n">max_it_fine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_it_fine</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>

        <span class="c1"># set non linearities. don&#39;t blame me for the awful logic: it comes</span>
        <span class="c1"># from the matlab program. I didn&#39;t dare to understand it and change</span>
        <span class="c1"># it.</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">==</span> <span class="s1">&#39;pow3&#39;</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="n">g</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">elif</span> <span class="n">g</span> <span class="o">==</span> <span class="s1">&#39;gaus&#39;</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">=</span> <span class="mi">40</span>

        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">mu</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gOrig</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">fine_tuning</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">fine_g</span> <span class="o">==</span> <span class="s1">&#39;pow3&#39;</span><span class="p">:</span>
            <span class="n">gFine</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="k">elif</span> <span class="n">fine_g</span> <span class="o">==</span> <span class="s1">&#39;tanh&#39;</span><span class="p">:</span>
            <span class="n">gFine</span> <span class="o">=</span> <span class="mi">21</span>
        <span class="k">elif</span> <span class="n">fine_g</span> <span class="o">==</span> <span class="s1">&#39;gaus&#39;</span><span class="p">:</span>
            <span class="n">gFine</span> <span class="o">=</span> <span class="mi">31</span>
        <span class="k">elif</span> <span class="n">fine_g</span> <span class="o">==</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span>
            <span class="n">gFine</span> <span class="o">=</span> <span class="mi">41</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gFine</span> <span class="o">=</span> <span class="n">gOrig</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stabilization</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">gFine</span> <span class="o">=</span> <span class="n">gOrig</span>
            <span class="n">fine_tuning</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">muK</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">used_g</span> <span class="o">=</span> <span class="n">gOrig</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fine_tuned</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">coarse_limit_reached</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lng</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># SYMMETRIC APPROACH</span>
        <span class="k">if</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;symm&#39;</span><span class="p">:</span>
            <span class="c1"># create list to store convergence</span>
            <span class="n">convergence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">convergence_fine</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># orthonormal initial vectors.</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">guess</span>
            <span class="n">QOld</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">QOldF</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="c1"># This is the actual fixed-point iteration loop.</span>
            <span class="k">for</span> <span class="nb">round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_it</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">round</span> <span class="o">==</span> <span class="n">max_it</span><span class="p">:</span>
                    <span class="n">errstr</span> <span class="o">=</span> <span class="s1">&#39;No convergence after </span><span class="si">%d</span><span class="s1"> steps</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">max_it</span>
                    <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">errstr</span><span class="p">)</span>


                <span class="c1"># Symmetric orthogonalization. Q = Q * real(inv(Q&#39; * Q)^(1/2));</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">))))</span>

                <span class="c1"># Test for termination condition. Note that we consider</span>
                <span class="c1"># opposite directions here as well.</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">QOld</span><span class="p">))</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">convergence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="nb">abs</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">QOldF</span><span class="p">))</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">convergence_fine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine_g</span> \
                   <span class="ow">and</span> <span class="n">coarse_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                   <span class="ow">and</span> <span class="n">convergence</span><span class="p">[</span><span class="nb">round</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">coarse_limit</span> \
                   <span class="ow">and</span> <span class="ow">not</span> <span class="n">coarse_limit_reached</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coarse convergence, switching to fine cost...&#39;</span><span class="p">)</span>
                    <span class="n">used_g</span> <span class="o">=</span> <span class="n">gFine</span>
                    <span class="n">coarse_limit_reached</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">convergence</span><span class="p">[</span><span class="nb">round</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fine_tuning</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fine_tuned</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial convergence, fine-tuning...&#39;</span><span class="p">)</span>
                        <span class="n">fine_tuned</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">used_g</span> <span class="o">=</span> <span class="n">gFine</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="n">muK</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
                        <span class="n">QOld</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                        <span class="n">QoldF</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Convergence after </span><span class="si">%d</span><span class="s1"> steps</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">round</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">stabilization</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">stroke</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">convergence_fine</span><span class="p">[</span><span class="nb">round</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stroke!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">stroke</span> <span class="o">=</span> <span class="n">mu</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span>
                        <span class="k">if</span> <span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">used_g</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">stroke</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="n">stroke</span>
                        <span class="n">stroke</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">used_g</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lng</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">round</span> <span class="o">&gt;</span> <span class="n">max_it</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Taking long (reducing step size)...&#39;</span><span class="p">)</span>
                        <span class="n">lng</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span>
                        <span class="k">if</span> <span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">used_g</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">QOldF</span> <span class="o">=</span> <span class="n">QOld</span>
                <span class="n">QOld</span> <span class="o">=</span> <span class="n">Q</span>

                <span class="c1"># Show the progress...</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Step no. </span><span class="si">%d</span><span class="s1">,&#39;</span>
                           <span class="s1">&#39; convergence: </span><span class="si">%.7f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">convergence</span><span class="p">[</span><span class="nb">round</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


                <span class="c1"># First calculate the independent components (u_i&#39;s).</span>
                <span class="c1"># u_i = b_i&#39; x = x&#39; b_i. For all x:s simultaneously this is</span>
                <span class="c1"># non linearity</span>
                <span class="k">if</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">Q</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Gpow3</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">Gpow3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">tlen</span><span class="p">))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Gpow3</span><span class="p">)</span> <span class="o">-</span>
                                               <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">Q</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Gpow3</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">Gpow3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Gpow3</span><span class="p">)</span> <span class="o">-</span>
                                               <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tang</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">fine_tanh</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span>
                                     <span class="n">fine_tanh</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span>
                                 <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span><span class="o">-</span>
                                       <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">tang</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">fine_tanh</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span>
                                     <span class="n">fine_tanh</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span>
                                 <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span><span class="o">-</span>
                                       <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">Q</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">31</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">gaus</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">gaus</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span>
                                     <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span>
                                 <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">gaus</span><span class="p">)</span><span class="o">-</span>
                                       <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">Q</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">33</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">gaus</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">gaus</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="n">Beta</span> <span class="o">-</span>
                                     <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))))</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">gaus</span><span class="p">)</span><span class="o">-</span>
                                               <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Gskew</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">Gskew</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Beta</span><span class="p">))</span>
                    <span class="n">Q</span> <span class="o">=</span>  <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Gskew</span><span class="p">)</span><span class="o">-</span>
                                                <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">43</span><span class="p">:</span>
                    <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
                    <span class="n">Gskew</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                    <span class="n">Beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">Gskew</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Beta</span><span class="p">))</span>
                    <span class="n">Q</span> <span class="o">=</span>  <span class="n">Q</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">mult</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Gskew</span><span class="p">)</span><span class="o">-</span>
                                                <span class="n">numx</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Beta</span><span class="p">)),</span> <span class="n">D</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errstr</span> <span class="o">=</span> <span class="s1">&#39;Nonlinearity not found: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">used_g</span>
                    <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">errstr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convergence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence_fine</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convergence_fine</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">convergence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># DEFLATION APPROACH</span>
        <span class="k">elif</span> <span class="n">approach</span> <span class="o">==</span> <span class="s1">&#39;defl&#39;</span><span class="p">:</span>
            <span class="c1"># adjust limit!</span>
            <span class="c1">#limit = 1 - limit*limit*0.5</span>
            <span class="c1"># create array to store convergence</span>
            <span class="n">convergence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">convergence_fine</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">comp</span><span class="p">,</span> <span class="n">comp</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="nb">round</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nfail</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nb">round</span> <span class="o">&lt;</span> <span class="n">comp</span><span class="p">:</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
                <span class="n">used_g</span> <span class="o">=</span> <span class="n">gOrig</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fine_tuned</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">lng</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">end_finetuning</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Take a random initial vector of lenght 1 and orthogonalize it</span>
                <span class="c1"># with respect to the other vectors.</span>
                <span class="n">w</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">[:,</span> <span class="nb">round</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">-=</span> <span class="n">mult</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">/=</span> <span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

                <span class="n">wOld</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="n">wOldF</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="c1"># This is the actual fixed-point iteration loop.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">gabba</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1">#for i in range(max_it + 1):</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_it</span> <span class="o">+</span> <span class="n">gabba</span><span class="p">:</span>
                    <span class="c1"># Project the vector into the space orthogonal to the space</span>
                    <span class="c1"># spanned by the earlier found basis vectors. Note that</span>
                    <span class="c1"># we can do the projection with matrix Q, since the zero</span>
                    <span class="c1"># entries do not contribute to the projection.</span>
                    <span class="n">w</span> <span class="o">-=</span> <span class="n">mult</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fine_tuned</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">max_it</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Component number </span><span class="si">%d</span><span class="s1"> did not&#39;</span>
                                       <span class="s1">&#39;converge in </span><span class="si">%d</span><span class="s1"> iterations.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="p">,</span>
                                                                       <span class="n">max_it</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">round</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                            <span class="n">nfail</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">nfail</span> <span class="o">&gt;</span> <span class="n">failures</span><span class="p">:</span>
                                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Too many failures to &#39;</span>
                                       <span class="s1">&#39;converge (</span><span class="si">%d</span><span class="s1">). Giving up.&#39;</span> <span class="o">%</span> <span class="n">nfail</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">end_finetuning</span><span class="p">:</span>
                            <span class="n">wOld</span> <span class="o">=</span> <span class="n">w</span>

                    <span class="c1"># Test for termination condition. Note that the algorithm</span>
                    <span class="c1"># has converged if the direction of w and wOld is the same.</span>
                    <span class="c1">#conv = float(abs((w*wOld).sum()))</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="n">wOld</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">wOld</span><span class="p">))</span>
                    <span class="n">convergence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">conv</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fine_tuning</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fine_tuned</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initial convergence, fine-tuning...&#39;</span><span class="p">)</span>
                            <span class="n">fine_tuned</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">gabba</span> <span class="o">=</span> <span class="n">max_it_fine</span>
                            <span class="n">wOld</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                            <span class="n">wOldF</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                            <span class="n">used_g</span> <span class="o">=</span> <span class="n">gFine</span>
                            <span class="n">mu</span> <span class="o">=</span> <span class="n">muK</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span>
                            <span class="n">end_finetuning</span> <span class="o">=</span> <span class="n">max_it_fine</span> <span class="o">+</span> <span class="n">i</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nfail</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">convergence</span><span class="p">[</span><span class="nb">round</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv</span>
                            <span class="c1"># Calculate ICA filter.</span>
                            <span class="n">Q</span><span class="p">[:,</span> <span class="nb">round</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="c1"># Show the progress...</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IC </span><span class="si">%d</span><span class="s1"> computed ( </span><span class="si">%d</span><span class="s1"> steps )&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                                                       <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">stabilization</span><span class="p">:</span>
                        <span class="n">conv_fine</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="n">wOldF</span><span class="p">),</span>
                                        <span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">wOldF</span><span class="p">))</span>
                        <span class="n">convergence_fine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_fine</span><span class="p">)</span>
                        <span class="k">if</span>  <span class="p">(</span><span class="n">stroke</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">conv_fine</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stroke!&#39;</span><span class="p">)</span>
                            <span class="n">stroke</span> <span class="o">=</span> <span class="n">mu</span>
                            <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span>
                            <span class="k">if</span> <span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">used_g</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">stroke</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">mu</span> <span class="o">=</span> <span class="n">stroke</span>
                            <span class="n">stroke</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">mu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="n">used_g</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lng</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_it</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Taking long (reducing step size)...&#39;</span><span class="p">)</span>
                            <span class="n">lng</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mu</span>
                            <span class="k">if</span> <span class="n">used_g</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">used_g</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">wOldF</span> <span class="o">=</span> <span class="n">wOld</span>
                    <span class="n">wOld</span> <span class="o">=</span> <span class="n">w</span>
                    <span class="k">if</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">w</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">EXGpow3</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">EXGpow3</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">EXGpow3</span> <span class="o">-</span> <span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">Beta</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">w</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">EXGpow3</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">EXGpow3</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">EXGpow3</span> <span class="o">-</span> <span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">Beta</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">mult</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span> <span class="o">-</span> <span class="n">fine_tanh</span><span class="o">*</span><span class="n">temp</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">-</span><span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">),(</span><span class="n">fine_tanh</span><span class="o">*</span><span class="n">temp</span><span class="o">-</span><span class="n">Beta</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">mult</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span> <span class="o">-</span> <span class="n">fine_tanh</span><span class="o">*</span><span class="n">temp</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">tang</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">fine_tanh</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">tang</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">fine_tanh</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">tang</span><span class="o">*</span><span class="n">tang</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span>
                                       <span class="n">Beta</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                        <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span> <span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span><span class="n">mult</span><span class="p">(</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">w</span><span class="p">)),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">31</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                        <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span> <span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                        <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span> <span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span>
                             <span class="n">mult</span><span class="p">(</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">w</span><span class="p">)),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">33</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span>
                        <span class="n">ex</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fine_gaus</span><span class="o">*</span><span class="n">u2</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">gauss</span> <span class="o">=</span>  <span class="n">u</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">dgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">fine_gaus</span> <span class="o">*</span><span class="n">u2</span><span class="p">)</span><span class="o">*</span><span class="n">ex</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="n">old_div</span><span class="p">((</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">dgauss</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">Beta</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">tlen</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">41</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">EXGskew</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span> <span class="n">tlen</span><span class="p">)</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">EXGskew</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">EXGskew</span> <span class="o">-</span> <span class="n">mult</span><span class="p">(</span><span class="n">Beta</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">Beta</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">42</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span><span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">used_g</span> <span class="o">==</span> <span class="mi">43</span><span class="p">:</span>
                        <span class="n">Xsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rsamples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">EXGskew</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">mult</span><span class="p">(</span><span class="n">Xsub</span><span class="p">,</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span><span class="p">),</span> <span class="n">Xsub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">Beta</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">EXGskew</span><span class="p">)</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">EXGskew</span> <span class="o">-</span> <span class="n">Beta</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">Beta</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errstr</span> <span class="o">=</span> <span class="s1">&#39;Nonlinearity not found: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">used_g</span>
                        <span class="k">raise</span> <span class="n">mdp</span><span class="o">.</span><span class="n">NodeException</span><span class="p">(</span><span class="n">errstr</span><span class="p">)</span>

                    <span class="c1"># Normalize the new w.</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="n">utils</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="nb">round</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convergence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convergence_fine</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convergence_fine</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">convergence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">TDSEPNode</span><span class="p">(</span><span class="n">ISFANode</span><span class="p">,</span> <span class="n">ProjectMatrixMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform Independent Component Analysis using the TDSEP algorithm.</span>
<span class="sd">    Note that TDSEP, as implemented in this Node, is an online algorithm,</span>
<span class="sd">    i.e. it is suited to be trained on huge data sets, provided that the</span>
<span class="sd">    training is done sending small chunks of data for each time.</span>

<span class="sd">    Reference:</span>
<span class="sd">    Ziehe, Andreas and Muller, Klaus-Robert (1998).</span>
<span class="sd">    TDSEP an efficient algorithm for blind separation using time structure.</span>
<span class="sd">    in Niklasson, L, Boden, M, and Ziemke, T (Editors), Proc. 8th Int. Conf.</span>
<span class="sd">    Artificial Neural Networks (ICANN 1998).</span>

<span class="sd">    **Internal variables of interest**</span>

<span class="sd">      ``self.white``</span>
<span class="sd">          The whitening node used for preprocessing.</span>

<span class="sd">      ``self.filters``</span>
<span class="sd">          The ICA filters matrix (this is the transposed of the</span>
<span class="sd">          projection matrix after whitening).</span>

<span class="sd">      ``self.convergence``</span>
<span class="sd">          The value of the convergence threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">whitened</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">white_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">white_parm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_dim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input arguments:</span>

<span class="sd">        lags    -- list of time-lags to generate the time-delayed covariance</span>
<span class="sd">                   matrices. If lags is an integer, time-lags 1,2,...,&#39;lags&#39;</span>
<span class="sd">                   are used.</span>
<span class="sd">                   Note that time-lag == 0 (instantaneous correlation) is</span>
<span class="sd">                   always implicitly used.</span>

<span class="sd">        whitened -- Set whitened is True if input data are already whitened.</span>
<span class="sd">                    Otherwise the node will whiten the data itself.</span>

<span class="sd">        white_comp -- If whitened is False, you can set &#39;white_comp&#39; to the</span>
<span class="sd">                      number of whitened components to keep during the</span>
<span class="sd">                      calculation (i.e., the input dimensions are reduced to</span>
<span class="sd">                      white_comp by keeping the components of largest variance).</span>

<span class="sd">        white_parm -- a dictionary with additional parameters for whitening.</span>
<span class="sd">                      It is passed directly to the WhiteningNode constructor.</span>
<span class="sd">                      Ex: white_parm = { &#39;svd&#39; : True }</span>

<span class="sd">        limit -- convergence threshold.</span>

<span class="sd">        max_iter     -- If the algorithms does not achieve convergence within</span>
<span class="sd">                        max_iter iterations raise an Exception. Should be</span>
<span class="sd">                        larger than 100.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TDSEPNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">sfa_ica_coeff</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                                        <span class="n">icaweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sfaweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">whitened</span><span class="o">=</span><span class="n">whitened</span><span class="p">,</span>
                                        <span class="n">white_comp</span><span class="o">=</span><span class="n">white_comp</span><span class="p">,</span>
                                        <span class="n">white_parm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">eps_contrast</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                                        <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">RP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                        <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span>
                                        <span class="n">output_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<div class="viewcode-block" id="TDSEPNode._stop_training"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.TDSEPNode._stop_training">[docs]</a>    <span class="k">def</span> <span class="nf">_stop_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TDSEPNode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_stop_training</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
        <span class="c1"># set filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RP</span>
        <span class="c1"># set convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_contrast</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on 2020-02-17 1:33:02 PM Coordinated Universal Time.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'3.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   
<div class="footer">
    <hr />
    <table>
      <tr>
        <td class="footer-left">
           <a href="http://sourceforge.net/projects/mdp-toolkit">
 <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=116959&amp;type=12"
      width="120" height="30" border="0" alt="MDP@SF.NET"/> </a>
        </td>
        <td class="footer-center">
          Last updated on
             2020-02-17 1:33:02 PM Coordinated Universal Time
        </td>
        <td class="footer-right">
         <form class="search" action="../../../search.html" method="get">
          <input type="submit" value="Search" />
          <input type="text" name="q" size="18" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
         </form>
        </td>
    </table>  
    <!-- Piwik -->
    <script type="text/javascript">
	var pkBaseURL = (("https:" == document.location.protocol) ? "https://sourceforge.net/apps/piwik/mdp-toolkit/" : "http://sourceforge.net/apps/piwik/mdp-toolkit/");
	document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
	piwik_action_name = '';
	piwik_idsite = 1;
	piwik_url = pkBaseURL + "piwik.php";
	piwik_log(piwik_action_name, piwik_idsite, piwik_url);
    </script>
    <object><noscript>
	    <p>
		<img src="http://sourceforge.net/apps/piwik/mdp-toolkit/piwik.php?idsite=1"
		     alt="piwik" />
	    </p>
    </noscript></object>
    <!-- End Piwik Tag -->
</div>   


</body>
</html>