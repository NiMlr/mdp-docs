

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mdp.nodes.isfa_nodes &mdash; Modular toolkit for Data Processing (MDP)</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Modular toolkit for Data Processing (MDP)" href="../../../index.html"/>
        <link rel="up" title="mdp.nodes" href="../nodes.html"/> 
<meta name="viewport" content="width=740" />


  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo_animation.gif" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_cite_mdp.html">How to cite MDP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contact.html">Contact</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MDP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../mdp.html">mdp</a> &raquo;</li>
        
          <li><a href="../nodes.html">mdp.nodes</a> &raquo;</li>
        
      <li>mdp.nodes.isfa_nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mdp.nodes.isfa_nodes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">past.utils</span> <span class="k">import</span> <span class="n">old_div</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span> <span class="k">as</span> <span class="nn">_sys</span>
<span class="kn">import</span> <span class="nn">mdp</span>
<span class="kn">from</span> <span class="nn">mdp</span> <span class="k">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">NodeException</span><span class="p">,</span> <span class="n">numx</span><span class="p">,</span> <span class="n">numx_rand</span>
<span class="kn">from</span> <span class="nn">mdp.nodes</span> <span class="k">import</span> <span class="n">WhiteningNode</span>
<span class="kn">from</span> <span class="nn">mdp.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">DelayCovarianceMatrix</span><span class="p">,</span> <span class="n">MultipleCovarianceMatrices</span><span class="p">,</span>
                       <span class="n">rotate</span><span class="p">,</span> <span class="n">mult</span><span class="p">)</span>


<span class="c1"># TODO: support floats of size different than 64-bit; will need to change SQRT_EPS_D</span>

<span class="c1"># rename often used functions</span>
<span class="nb">sum</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">PI</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">numx</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="n">numx</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="n">numx</span><span class="o">.</span><span class="n">pi</span>
<span class="n">SQRT_EPS_D</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numx</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

<div class="viewcode-block" id="_triu"><a class="viewcode-back" href="../../../mdp/mdp.nodes.isfa_nodes.html#mdp.nodes._triu">[docs]</a><span class="k">def</span> <span class="nf">_triu</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns the elements on and above the k-th diagonal of m.  k=0 is the</span>
<span class="sd">        main diagonal, k &gt; 0 is above and k &lt; 0 is below the main diagonal.&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">numx</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">numx</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                                               <span class="n">numx</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">M</span><span class="p">)),</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">m</span>
    <span class="k">return</span> <span class="n">out</span></div>

<span class="c1">#############</span>
<span class="k">class</span> <span class="nc">ISFANode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Independent Slow Feature Analysis on the input data.</span>

<span class="sd">    **Internal variables of interest**</span>

<span class="sd">      ``self.RP``</span>
<span class="sd">          The global rotation-permutation matrix. This is the filter</span>
<span class="sd">          applied on input_data to get output_data</span>

<span class="sd">      ``self.RPC``</span>
<span class="sd">          The *complete* global rotation-permutation matrix. This</span>
<span class="sd">          is a matrix of dimension input_dim x input_dim (the &#39;outer space&#39;</span>
<span class="sd">          is retained)</span>

<span class="sd">      ``self.covs``</span>
<span class="sd">          A `mdp.utils.MultipleCovarianceMatrices` instance containing</span>
<span class="sd">          the current time-delayed covariance matrices of the input_data.</span>
<span class="sd">          After convergence the uppermost ``output_dim`` x ``output_dim``</span>
<span class="sd">          submatrices should be almost diagonal.</span>
<span class="sd">          </span>
<span class="sd">          ``self.covs[n-1]`` is the covariance matrix relative to the ``n``-th</span>
<span class="sd">          time-lag</span>
<span class="sd">            </span>
<span class="sd">          Note: they are not cleared after convergence. If you need to free</span>
<span class="sd">          some memory, you can safely delete them with::</span>
<span class="sd">          </span>
<span class="sd">              &gt;&gt;&gt; del self.covs</span>

<span class="sd">      ``self.initial_contrast``</span>
<span class="sd">          A dictionary with the starting contrast and the SFA and ICA parts of</span>
<span class="sd">          it.</span>

<span class="sd">      ``self.final_contrast``</span>
<span class="sd">          Like the above but after convergence.</span>

<span class="sd">    Note: If you intend to use this node for large datasets please have</span>
<span class="sd">    a look at the ``stop_training`` method documentation for</span>
<span class="sd">    speeding things up.</span>

<span class="sd">    References:</span>
<span class="sd">    Blaschke, T. , Zito, T., and Wiskott, L. (2007).</span>
<span class="sd">    Independent Slow Feature Analysis and Nonlinear Blind Source Separation.</span>
<span class="sd">    Neural Computation 19(4):994-1021 (2007)</span>
<span class="sd">    http://itb.biologie.hu-berlin.de/~wiskott/Publications/BlasZitoWisk2007-ISFA-NeurComp.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sfa_ica_coeff</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">icaweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sfaweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">whitened</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">white_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">white_parm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">eps_contrast</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                 <span class="n">RP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Independent Slow Feature Analysis.</span>

<span class="sd">        The notation is the same used in the paper by Blaschke et al. Please</span>
<span class="sd">        refer to the paper for more information.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">          lags</span>
<span class="sd">            list of time-lags to generate the time-delayed covariance</span>
<span class="sd">            matrices (in the paper this is the set of \tau). If</span>
<span class="sd">            lags is an integer, time-lags 1,2,...,&#39;lags&#39; are used.</span>
<span class="sd">            Note that time-lag == 0 (instantaneous correlation) is</span>
<span class="sd">            always implicitly used.</span>

<span class="sd">          sfa_ica_coeff</span>
<span class="sd">            a list of float with two entries, which defines the</span>
<span class="sd">            weights of the SFA and ICA part of the objective</span>
<span class="sd">            function. They are called b_{SFA} and b_{ICA} in the</span>
<span class="sd">            paper.</span>

<span class="sd">          sfaweights</span>
<span class="sd">            weighting factors for the covariance matrices relative</span>
<span class="sd">            to the SFA part of the objective function (called</span>
<span class="sd">            \kappa_{SFA}^{\tau} in the paper). Default is</span>
<span class="sd">            [1., 0., ..., 0.]</span>
<span class="sd">            For possible values see the description of icaweights.</span>

<span class="sd">          icaweights</span>
<span class="sd">            weighting factors for the cov matrices relative</span>
<span class="sd">            to the ICA part of the objective function (called</span>
<span class="sd">            \kappa_{ICA}^{\tau} in the paper). Default is 1.</span>
<span class="sd">            Possible values are:</span>

<span class="sd">            - an integer ``n``: all matrices are weighted the same</span>
<span class="sd">              (note that it does not make sense to have ``n != 1``)</span>

<span class="sd">            - a list or array of floats of ``len == len(lags)``:</span>
<span class="sd">              each element of the list is used for weighting the</span>
<span class="sd">              corresponding matrix</span>

<span class="sd">            - ``None``: use the default values.</span>

<span class="sd">          whitened</span>
<span class="sd">            ``True`` if input data is already white, ``False``</span>
<span class="sd">            otherwise (the data will be whitened internally).</span>

<span class="sd">          white_comp</span>
<span class="sd">            If whitened is false, you can set ``white_comp`` to the</span>
<span class="sd">            number of whitened components to keep during the</span>
<span class="sd">            calculation (i.e., the input dimensions are reduced to</span>
<span class="sd">            ``white_comp`` by keeping the components of largest variance).</span>
<span class="sd">          white_parm</span>
<span class="sd">            a dictionary with additional parameters for whitening.</span>
<span class="sd">            It is passed directly to the WhiteningNode constructor.</span>
<span class="sd">            Ex: white_parm = { &#39;svd&#39; : True }</span>

<span class="sd">          eps_contrast</span>
<span class="sd">            Convergence is achieved when the relative</span>
<span class="sd">            improvement in the contrast is below this threshold.</span>
<span class="sd">            Values in the range [1E-4, 1E-10] are usually</span>
<span class="sd">            reasonable.</span>

<span class="sd">          max_iter</span>
<span class="sd">            If the algorithms does not achieve convergence within</span>
<span class="sd">            max_iter iterations raise an Exception. Should be</span>
<span class="sd">            larger than 100.</span>

<span class="sd">          RP</span>
<span class="sd">            Starting rotation-permutation matrix. It is an</span>
<span class="sd">            input_dim x input_dim matrix used to initially rotate the</span>
<span class="sd">            input components. If not set, the identity matrix is used.</span>
<span class="sd">            In the paper this is used to start the algorithm at the</span>
<span class="sd">            SFA solution (which is often quite near to the optimum).</span>

<span class="sd">          verbose</span>
<span class="sd">            print progress information during convergence. This can</span>
<span class="sd">            slow down the algorithm, but it&#39;s the only way to see</span>
<span class="sd">            the rate of improvement and immediately spot if something</span>
<span class="sd">            is going wrong.</span>

<span class="sd">          output_dim</span>
<span class="sd">            sets the number of independent components that have to</span>
<span class="sd">            be extracted. Note that if this is not smaller than</span>
<span class="sd">            input_dim, the problem is solved linearly and SFA</span>
<span class="sd">            would give the same solution only much faster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check that the &quot;lags&quot; argument has some meaningful value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">lags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lags</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">lags</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">numx</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lags</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">]):</span>
                <span class="n">err_str</span> <span class="o">=</span> <span class="s2">&quot;lags must be integer!&quot;</span>
                <span class="k">raise</span> <span class="n">NodeException</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Lags must be int, list or array. Found &quot;</span>
                       <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">NodeException</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lags</span> <span class="o">=</span> <span class="n">lags</span>

        <span class="c1"># sanity checks for weights</span>
        <span class="k">if</span> <span class="n">icaweights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">icaweights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;icaweights vector length is </span><span class="si">%d</span><span class="s2">, &quot;</span>
                       <span class="s2">&quot;should be </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">icaweights</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">))))</span>
                <span class="k">raise</span> <span class="n">NodeException</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span> <span class="o">=</span> <span class="n">icaweights</span>

        <span class="k">if</span> <span class="n">sfaweights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sfaweights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sfaweights vector length is </span><span class="si">%d</span><span class="s2">, &quot;</span>
                       <span class="s2">&quot;should be </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sfaweights</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">))))</span>
                <span class="k">raise</span> <span class="n">NodeException</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span> <span class="o">=</span> <span class="n">sfaweights</span>

        <span class="c1"># store attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfa_ica_coeff</span> <span class="o">=</span> <span class="n">sfa_ica_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_contrast</span> <span class="o">=</span> <span class="n">eps_contrast</span>

        <span class="c1"># if input is not white, insert a WhiteningNode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span> <span class="o">=</span> <span class="n">whitened</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">whitened</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">white_parm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">white_parm</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">output_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">white_comp</span> <span class="o">=</span> <span class="n">output_dim</span>
            <span class="k">elif</span> <span class="n">white_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_dim</span> <span class="o">=</span> <span class="n">white_comp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white</span> <span class="o">=</span> <span class="n">WhiteningNode</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span>
                                       <span class="n">output_dim</span><span class="o">=</span><span class="n">white_comp</span><span class="p">,</span>
                                       <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">white_parm</span><span class="p">)</span>

        <span class="c1"># initialize covariance matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">DelayCovarianceMatrix</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">lags</span> <span class="p">]</span>

        <span class="c1"># initialize the global rotation-permutation matrix</span>
        <span class="c1"># if not set that we&#39;ll eventually be an identity matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RP</span> <span class="o">=</span> <span class="n">RP</span>

        <span class="c1"># initialize verbose structure to print nice and useful progress info</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sweep&#39;</span> <span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)),</span> <span class="mi">5</span><span class="p">),</span>
                     <span class="s1">&#39;perturbe&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">)),</span> <span class="mi">5</span><span class="p">),</span>
                     <span class="s1">&#39;float&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span>
                     <span class="s1">&#39;fmt&#39;</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="si">%.5e</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;sep&#39;</span> <span class="p">:</span> <span class="s2">&quot; | &quot;</span><span class="p">}</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="s2">&quot;Sweep&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sweep&#39;</span><span class="p">])</span>
            <span class="n">f1_2</span> <span class="o">=</span> <span class="s2">&quot;Pertb&quot;</span><span class="o">.</span> <span class="n">center</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;perturbe&#39;</span><span class="p">])</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="s2">&quot;SFA part&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
            <span class="n">f3</span> <span class="o">=</span> <span class="s2">&quot;ICA part&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
            <span class="n">f4</span> <span class="o">=</span> <span class="s2">&quot;Contrast&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;sep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f1</span><span class="p">,</span> <span class="n">f1_2</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">])</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;-&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">info</span>

        <span class="c1"># finally call base class constructor</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ISFANode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

<div class="viewcode-block" id="ISFANode._get_supported_dtypes"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._get_supported_dtypes">[docs]</a>    <span class="k">def</span> <span class="nf">_get_supported_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of dtypes supported by this node.</span>
<span class="sd">      </span>
<span class="sd">        Support floating point types with size larger or equal than 64 bits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mdp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_dtypes</span><span class="p">(</span><span class="s1">&#39;Float&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">itemsize</span><span class="o">&gt;=</span><span class="mi">8</span><span class="p">]</span></div>

<div class="viewcode-block" id="ISFANode._set_dtype"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._set_dtype">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="c1"># when typecode is set, we set the whitening node if needed and</span>
        <span class="c1"># the SFA and ICA weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ISFANode._set_input_dim"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._set_input_dim">[docs]</a>    <span class="k">def</span> <span class="nf">_set_input_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_dim</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">output_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">output_dim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span> <span class="o">=</span> <span class="n">n</span></div>

<div class="viewcode-block" id="ISFANode._train"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._train">[docs]</a>    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># train the whitening node if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># update the covariance matrices</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">))]</span></div>

<div class="viewcode-block" id="ISFANode._execute"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._execute">[docs]</a>    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># filter through whitening node if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># rotate input</span>
        <span class="k">return</span> <span class="n">mult</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RP</span><span class="p">)</span></div>

<div class="viewcode-block" id="ISFANode._inverse"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._inverse">[docs]</a>    <span class="k">def</span> <span class="nf">_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># counter-rotate input</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RP</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="c1"># invert whitening node if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="ISFANode._fmt_prog_info"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._fmt_prog_info">[docs]</a>    <span class="k">def</span> <span class="nf">_fmt_prog_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweep</span><span class="p">,</span> <span class="n">pert</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">sfa</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ica</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># for internal use only!</span>
        <span class="c1"># format the progress information</span>
        <span class="c1"># don&#39;t try to understand this code: it Just Works (TM)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
        <span class="n">sweep_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sweep</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;sweep&#39;</span><span class="p">])</span>
        <span class="n">pert_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pert</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;perturbe&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sfa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sfa_str</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sfa_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;fmt&#39;</span><span class="p">]</span><span class="o">%</span><span class="p">(</span><span class="n">sfa</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ica</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ica_str</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ica_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;fmt&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">ica</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
        <span class="n">contrast_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;fmt&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">contrast</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])</span>
        <span class="n">table_entry</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[</span><span class="s1">&#39;sep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sweep_str</span><span class="p">,</span>
                                       <span class="n">pert_str</span><span class="p">,</span>
                                       <span class="n">sfa_str</span><span class="p">,</span>
                                       <span class="n">ica_str</span><span class="p">,</span>
                                       <span class="n">contrast_str</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">table_entry</span></div>

<div class="viewcode-block" id="ISFANode._get_eye"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._get_eye">[docs]</a>    <span class="k">def</span> <span class="nf">_get_eye</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return an identity matrix with the right dimensions and type</span>
        <span class="k">return</span> <span class="n">numx</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ISFANode._get_rnd_rotation"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._get_rnd_rotation">[docs]</a>    <span class="k">def</span> <span class="nf">_get_rnd_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="c1"># return a random rot matrix with the right dimensions and type</span>
        <span class="k">return</span> <span class="n">mdp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">random_rot</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ISFANode._get_rnd_permutation"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._get_rnd_permutation">[docs]</a>    <span class="k">def</span> <span class="nf">_get_rnd_permutation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="c1"># return a random permut matrix with the right dimensions and type</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">numx_rand</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
            <span class="n">zero</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">zero</span></div>

<div class="viewcode-block" id="ISFANode._givens_angle"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._givens_angle">[docs]</a>    <span class="k">def</span> <span class="nf">_givens_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">bica_bsfa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Return the Givens rotation angle for which the contrast function</span>
        <span class="c1"># is minimal</span>
        <span class="k">if</span> <span class="n">bica_bsfa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bica_bsfa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bica_bsfa</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_givens_angle_case1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span>
                                            <span class="n">bica_bsfa</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="n">complete</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_givens_angle_case2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span>
                                            <span class="n">bica_bsfa</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="n">complete</span><span class="p">)</span></div>


<div class="viewcode-block" id="ISFANode._givens_angle_case2"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._givens_angle_case2">[docs]</a>    <span class="k">def</span> <span class="nf">_givens_angle_case2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">bica_bsfa</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># This function makes use of the constants computed in the paper</span>
        <span class="c1">#</span>
        <span class="c1"># R -&gt; R</span>
        <span class="c1"># m -&gt; \mu</span>
        <span class="c1"># n -&gt; \nu</span>
        <span class="c1">#</span>
        <span class="c1"># Note that the minus sign before the angle phi is there because</span>
        <span class="c1"># in the paper the rotation convention is the opposite of ours.</span>

        <span class="n">ncovs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">ncovs</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">covs</span>
        <span class="n">icaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span>
        <span class="n">sfaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span>
        <span class="n">bica</span><span class="p">,</span> <span class="n">bsfa</span> <span class="o">=</span> <span class="n">bica_bsfa</span>

        <span class="n">Cmm</span><span class="p">,</span> <span class="n">Cmn</span><span class="p">,</span> <span class="n">Cnn</span> <span class="o">=</span> <span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:],</span> <span class="n">covs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">d0</span> <span class="o">=</span>   <span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="n">Cmm</span><span class="o">*</span><span class="n">Cmm</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="n">Cmn</span><span class="o">*</span><span class="n">Cmm</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Cmn</span><span class="o">*</span><span class="n">Cmn</span> <span class="o">+</span> <span class="n">Cmm</span><span class="o">*</span><span class="n">Cnn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="n">Cmn</span><span class="o">*</span><span class="n">Cnn</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d4</span> <span class="o">=</span>   <span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="n">Cnn</span><span class="o">*</span><span class="n">Cnn</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="p">((</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                              <span class="o">-</span> <span class="n">Cmm</span><span class="o">*</span><span class="n">Cmm</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="p">((</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                              <span class="o">-</span> <span class="n">Cmm</span><span class="o">*</span><span class="n">Cmn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="p">((</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                              <span class="o">-</span> <span class="n">Cmn</span><span class="o">*</span><span class="n">Cmn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">s22</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="n">d1</span><span class="o">+</span><span class="n">d3</span><span class="p">)</span>   <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span> <span class="n">bica</span><span class="o">*</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="o">*</span> <span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="n">d0</span><span class="o">-</span><span class="n">d4</span><span class="p">)</span>   <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span> <span class="n">bica</span><span class="o">*</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">e2</span><span class="p">)</span>
        <span class="n">s24</span> <span class="o">=</span> <span class="mf">0.125</span><span class="o">*</span> <span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="n">d1</span><span class="o">-</span><span class="n">d3</span><span class="p">)</span>
        <span class="n">c24</span> <span class="o">=</span> <span class="mf">0.125</span><span class="o">*</span> <span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="n">d0</span><span class="o">-</span><span class="n">d2</span><span class="o">+</span><span class="n">d4</span><span class="p">)</span>

        <span class="c1"># Compute the contrast function in a grid of angles to find a</span>
        <span class="c1"># first approximation for the minimum.  Repeat two times</span>
        <span class="c1"># (effectively doubling the resolution). Note that we can do</span>
        <span class="c1"># that because we know we have a single minimum.</span>
        <span class="c1">#</span>
        <span class="c1"># npoints should not be too large otherwise the contrast</span>
        <span class="c1"># funtion appears to be constant. This is because we hit the</span>
        <span class="c1"># maximum resolution for the cosine function (ca. 1e-15)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="o">-</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,(</span><span class="n">npoints</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,(</span><span class="n">npoints</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">npoints</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">c22</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span><span class="o">+</span><span class="n">s22</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span><span class="o">+</span>\
                       <span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span><span class="o">+</span><span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">minidx</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">minidx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">minidx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># The contrast is almost a parabola around the minimum.</span>
        <span class="c1"># To find the minimum we can therefore compute the derivative</span>
        <span class="c1"># (which should be a line) and calculate its root.</span>
        <span class="c1"># This step helps to overcome the resolution limit of the</span>
        <span class="c1"># cosine function and clearly improve the final result.</span>
        <span class="n">der_left</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">c22</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">left</span><span class="p">)</span><span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">s22</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">left</span><span class="p">)</span><span class="o">+</span>\
                   <span class="mi">4</span><span class="o">*</span><span class="n">c24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">left</span><span class="p">)</span><span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">s24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">left</span><span class="p">)</span>
        <span class="n">der_right</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">c22</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">right</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">s22</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">right</span><span class="p">)</span><span class="o">+</span>\
                    <span class="mi">4</span><span class="o">*</span><span class="n">c24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">right</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">s24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">right</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">der_left</span> <span class="o">-</span> <span class="n">der_right</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SQRT_EPS_D</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">minidx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">der_right</span><span class="o">*</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">der_right</span><span class="o">-</span><span class="n">der_left</span><span class="p">)</span>

        <span class="n">dc</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">):</span>
            <span class="n">dg</span> <span class="o">=</span> <span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="p">:</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
            <span class="n">dc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dg</span><span class="o">*</span><span class="n">dg</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="p">((</span><span class="n">dc</span><span class="o">-</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cmm</span><span class="p">)</span><span class="o">*</span><span class="n">sfaweights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">ec</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">):</span>
            <span class="n">ec</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">*</span><span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">m</span><span class="p">])</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ec</span><span class="o">*</span><span class="n">icaweights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">a20</span> <span class="o">=</span> <span class="mf">0.125</span><span class="o">*</span><span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">d0</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">d4</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">dc</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">bica</span><span class="o">*</span><span class="p">(</span><span class="n">e0</span><span class="o">+</span><span class="n">e2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">ec</span><span class="p">)</span>
        <span class="n">minimum_contrast</span> <span class="o">=</span> <span class="n">a20</span><span class="o">+</span><span class="n">c22</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span><span class="o">+</span><span class="n">s22</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span><span class="o">+</span>\
                           <span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span><span class="o">+</span><span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
            <span class="c1"># Compute the contrast between -pi/2 and pi/2</span>
            <span class="c1"># (useful for testing purposes)</span>
            <span class="n">npoints</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="o">-</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">npoints</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">a20</span> <span class="o">+</span> <span class="n">c22</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">s22</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span>\
                       <span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">minimum_contrast</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">minimum_contrast</span></div>


<div class="viewcode-block" id="ISFANode._givens_angle_case1"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._givens_angle_case1">[docs]</a>    <span class="k">def</span> <span class="nf">_givens_angle_case1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">bica_bsfa</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># This function makes use of the constants computed in the paper</span>
        <span class="c1">#</span>
        <span class="c1"># R -&gt; R</span>
        <span class="c1"># m -&gt; \mu</span>
        <span class="c1"># n -&gt; \nu</span>
        <span class="c1">#</span>
        <span class="c1"># Note that the minus sign before the angle phi is there because</span>
        <span class="c1"># in the paper the rotation convention is the opposite of ours.</span>
        <span class="n">ncovs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">ncovs</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">covs</span>
        <span class="n">icaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span>
        <span class="n">sfaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span>
        <span class="n">bica</span><span class="p">,</span> <span class="n">bsfa</span> <span class="o">=</span> <span class="n">bica_bsfa</span>

        <span class="n">Cmm</span><span class="p">,</span> <span class="n">Cmn</span><span class="p">,</span> <span class="n">Cnn</span> <span class="o">=</span> <span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="p">:],</span> <span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:],</span> <span class="n">covs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">d0</span> <span class="o">=</span>   <span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="p">(</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cmm</span><span class="o">+</span><span class="n">Cnn</span><span class="o">*</span><span class="n">Cnn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="p">(</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cmn</span><span class="o">-</span><span class="n">Cmn</span><span class="o">*</span><span class="n">Cnn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sfaweights</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Cmn</span><span class="o">*</span><span class="n">Cmn</span><span class="o">+</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cnn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="n">Cmn</span><span class="o">*</span><span class="n">Cmn</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="p">(</span><span class="n">Cmn</span><span class="o">*</span><span class="n">Cnn</span><span class="o">-</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cmn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">e2</span> <span class="o">=</span>   <span class="p">(</span><span class="n">icaweights</span> <span class="o">*</span> <span class="p">((</span><span class="n">Cmm</span><span class="o">-</span><span class="n">Cnn</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Cmm</span><span class="o">-</span><span class="n">Cnn</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Cmn</span><span class="o">*</span><span class="n">Cmn</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">s24</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span> <span class="p">(</span><span class="n">bsfa</span> <span class="o">*</span> <span class="n">d1</span>    <span class="o">+</span> <span class="n">bica</span> <span class="o">*</span> <span class="n">e1</span><span class="p">)</span>
        <span class="n">c24</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span> <span class="p">(</span><span class="n">bsfa</span> <span class="o">*</span><span class="p">(</span><span class="n">d0</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span><span class="o">+</span> <span class="n">bica</span> <span class="o">*</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">e2</span><span class="p">))</span>

        <span class="c1"># compute the exact minimum</span>
        <span class="c1"># Note that &#39;arctan&#39; finds always the first maximum</span>
        <span class="c1"># because s24sin(4p)+c24cos(4p)=const*cos(4p-arctan)</span>
        <span class="c1"># the minimum lies +pi/4 apart (period = pi/2).</span>
        <span class="c1"># In other words we want that: abs(minimum) &lt; pi/4</span>
        <span class="n">phi4</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s24</span><span class="p">,</span> <span class="n">c24</span><span class="p">)</span>
        <span class="c1"># use if-structure until bug in numx.sign is solved</span>
        <span class="k">if</span>  <span class="n">phi4</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">phi4</span><span class="o">-</span><span class="n">PI</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">phi4</span><span class="o">+</span><span class="n">PI</span><span class="p">)</span>

        <span class="c1"># compute all constants:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">):</span>
            <span class="n">dg</span> <span class="o">=</span> <span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="p">:</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
            <span class="n">dc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dg</span><span class="o">*</span><span class="n">dg</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="p">((</span><span class="n">dc</span><span class="o">-</span><span class="n">Cnn</span><span class="o">*</span><span class="n">Cnn</span><span class="o">-</span><span class="n">Cmm</span><span class="o">*</span><span class="n">Cmm</span><span class="p">)</span><span class="o">*</span><span class="n">sfaweights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">):</span>
            <span class="n">triu_covs</span> <span class="o">=</span> <span class="n">_triu</span><span class="p">(</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="p">:</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">ec</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">triu_covs</span><span class="o">*</span><span class="n">triu_covs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">*</span><span class="n">covs</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">icaweights</span><span class="o">*</span><span class="n">ec</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">a20</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">bsfa</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">dc</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">d0</span><span class="p">)</span><span class="o">+</span><span class="n">bica</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">ec</span><span class="o">+</span><span class="n">e2</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">e0</span><span class="p">))</span>
        <span class="n">minimum_contrast</span> <span class="o">=</span> <span class="n">a20</span><span class="o">+</span><span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span><span class="o">+</span><span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">minimum</span><span class="p">)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">if</span> <span class="n">complete</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Compute the contrast between -pi/2 and pi/2</span>
            <span class="c1"># (useful for testing purposes)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="o">-</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">npoints</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">a20</span> <span class="o">+</span> <span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">minimum_contrast</span>
        <span class="k">elif</span> <span class="n">complete</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">old_div</span><span class="p">(</span><span class="o">-</span><span class="n">PI</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">old_div</span><span class="p">(</span><span class="n">PI</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">npoints</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">a20</span> <span class="o">+</span> <span class="n">c24</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">s24</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">minimum_contrast</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">minimum_contrast</span></div>


<div class="viewcode-block" id="ISFANode._get_contrast"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._get_contrast">[docs]</a>    <span class="k">def</span> <span class="nf">_get_contrast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">bica_bsfa</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bica_bsfa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bica_bsfa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bica_bsfa</span>
        <span class="c1"># return current value of the contrast</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span>
        <span class="n">ncovs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">ncovs</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="n">covs</span><span class="o">.</span><span class="n">covs</span>
        <span class="n">icaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icaweights</span>
        <span class="n">sfaweights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfaweights</span>
        <span class="c1"># unpack the bsfa and bica coefficients</span>
        <span class="n">bica</span><span class="p">,</span> <span class="n">bsfa</span> <span class="o">=</span> <span class="n">bica_bsfa</span>
        <span class="n">sfa</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">ica</span> <span class="o">=</span> <span class="n">numx</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncovs</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncovs</span><span class="p">):</span>
            <span class="n">sq_corr</span> <span class="o">=</span>  <span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="p">:</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span><span class="o">*</span><span class="n">covs</span><span class="p">[:</span><span class="n">R</span><span class="p">,</span> <span class="p">:</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">sfa</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">sq_corr</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
            <span class="n">ica</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">_triu</span><span class="p">(</span><span class="n">sq_corr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">bsfa</span><span class="o">*</span><span class="n">sfaweights</span><span class="o">*</span><span class="n">sfa</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">bica</span><span class="o">*</span><span class="n">icaweights</span><span class="o">*</span><span class="n">ica</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="ISFANode._adjust_ica_sfa_coeff"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._adjust_ica_sfa_coeff">[docs]</a>    <span class="k">def</span> <span class="nf">_adjust_ica_sfa_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># adjust sfa/ica ratio. ica and sfa term are scaled</span>
        <span class="c1"># differently because sfa accounts for the diagonal terms</span>
        <span class="c1"># whereas ica accounts for the off-diagonal terms</span>
        <span class="n">ncomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span>
        <span class="k">if</span> <span class="n">ncomp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bica</span> <span class="o">=</span>  <span class="n">old_div</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfa_ica_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="n">ncomp</span><span class="o">*</span><span class="p">(</span><span class="n">ncomp</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">bsfa</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sfa_ica_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ncomp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bica</span> <span class="o">=</span>  <span class="mf">0.</span><span class="c1">#self.sfa_ica_coeff[1]</span>
            <span class="n">bsfa</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sfa_ica_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bica_bsfa</span> <span class="o">=</span> <span class="p">[</span><span class="n">bica</span><span class="p">,</span> <span class="n">bsfa</span><span class="p">]</span></div>

<div class="viewcode-block" id="ISFANode._fix_covs"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._fix_covs">[docs]</a>    <span class="k">def</span> <span class="nf">_fix_covs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># fiv covariance matrices</span>
        <span class="k">if</span> <span class="n">covs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitened</span><span class="p">:</span>
                <span class="n">white</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white</span>
                <span class="n">white</span><span class="o">.</span><span class="n">stop_training</span><span class="p">()</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">white</span><span class="o">.</span><span class="n">get_projmatrix</span><span class="p">(</span><span class="n">transposed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># fix and whiten the covariance matrices</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lags</span><span class="p">)):</span>
                <span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">avg</span><span class="p">,</span> <span class="n">avg_dt</span><span class="p">,</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

            <span class="c1"># send the matrices to the container class</span>
            <span class="n">covs</span> <span class="o">=</span> <span class="n">MultipleCovarianceMatrices</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
            <span class="c1"># symmetrize the cov matrices</span>
            <span class="n">covs</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covs</span> <span class="o">=</span> <span class="n">covs</span></div>

<div class="viewcode-block" id="ISFANode._optimize"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._optimize">[docs]</a>    <span class="k">def</span> <span class="nf">_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># optimize contrast function</span>

        <span class="c1"># save initial contrast</span>
        <span class="n">sfa</span><span class="p">,</span> <span class="n">ica</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_contrast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_contrast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SFA&#39;</span><span class="p">:</span> <span class="n">sfa</span><span class="p">,</span>
                                 <span class="s1">&#39;ICA&#39;</span><span class="p">:</span> <span class="n">ica</span><span class="p">,</span>
                                 <span class="s1">&#39;TOT&#39;</span><span class="p">:</span> <span class="n">sfa</span> <span class="o">+</span> <span class="n">ica</span><span class="p">}</span>
        <span class="c1"># info headers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">])</span>

        <span class="c1"># initialize control variables</span>
        <span class="c1"># contrast</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">sfa</span><span class="o">+</span><span class="n">ica</span>
        <span class="c1"># local rotation matrix</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eye</span><span class="p">()</span>
        <span class="c1"># local copy of correlation matrices</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># maximum improvement in the contrast function</span>
        <span class="n">max_increase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_contrast</span>
        <span class="c1"># Number of sweeps</span>
        <span class="n">sweep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># flag for stopping sweeping</span>
        <span class="n">sweeping</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># flag to check if we already perturbed the outer space</span>
        <span class="c1"># - negative means that we exit from this routine</span>
        <span class="c1">#   because we hit numerical precision or because</span>
        <span class="c1">#   there&#39;s no outer space to be perturbed (input_dim == outpu_dim)</span>
        <span class="c1"># - positive means the number of perturbations done</span>
        <span class="c1">#   before finding no further improvement</span>
        <span class="n">perturbed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># size of the perturbation matrix</span>
        <span class="n">psize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span>

        <span class="c1"># if there is no outer space don&#39;t perturbe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">:</span>
            <span class="n">perturbed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># local eye matrix</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eye</span><span class="p">()</span>

        <span class="c1"># main loop</span>
        <span class="c1"># we&#39;ll keep on sweeping until the contrast has improved less</span>
        <span class="c1"># then self.eps_contrast</span>
        <span class="n">part_sweep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">sweeping</span><span class="p">:</span>
            <span class="c1"># update number of sweeps</span>
            <span class="n">sweep</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># perform a single sweep</span>
            <span class="n">max_increase</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_sweep</span><span class="p">(</span><span class="n">covs</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">contrast</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">max_increase</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">contrast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># we hit numerical precision, exit!</span>
                <span class="n">sweeping</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">perturbed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">perturbed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">perturbed</span> <span class="o">=</span> <span class="o">-</span><span class="n">perturbed</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">max_increase</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_contrast</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">max_increase</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="c1"># rate of change is small for all pairs in a sweep</span>
                <span class="k">if</span> <span class="n">perturbed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># perturbe the outer space one time with a random rotation</span>
                    <span class="n">perturbed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">perturbed</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">part_sweep</span> <span class="o">==</span> <span class="n">sweep</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># after the last pertubation no useful step has</span>
                    <span class="c1"># been done. exit!</span>
                    <span class="n">sweeping</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">perturbed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># we can&#39;t perturbe anymore</span>
                    <span class="n">sweeping</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># keep track of the last sweep we perturbed</span>
                <span class="n">part_sweep</span> <span class="o">=</span> <span class="n">sweep</span>

            <span class="c1"># perform perturbation if needed</span>
            <span class="k">if</span> <span class="n">perturbed</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sweeping</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># generate a random rotation matrix for the external subspace</span>
                <span class="n">PRT</span> <span class="o">=</span> <span class="n">eye</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rnd_rotation</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
                <span class="c1"># generate a random permutation matrix for the ext. subspace</span>
                <span class="n">perm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rnd_permutation</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
                <span class="c1"># combine rotation and permutation</span>
                <span class="n">rot_perm</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">rot</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>
                <span class="c1"># apply rotation+permutation</span>
                <span class="n">PRT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">:]</span> <span class="o">=</span> <span class="n">rot_perm</span>
                <span class="n">covs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">PRT</span><span class="p">)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">PRT</span><span class="p">)</span>
                <span class="c1"># increment perturbation counter</span>
                <span class="n">perturbed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># verbose progress information</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">table_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fmt_prog_info</span><span class="p">(</span><span class="n">sweep</span><span class="p">,</span>
                                                  <span class="n">perturbed</span><span class="p">,</span>
                                                  <span class="n">contrast</span><span class="p">)</span>
                <span class="n">_sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_entry</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">table_entry</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\b</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">_sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># if we made too many sweeps exit with error!</span>
            <span class="k">if</span> <span class="n">sweep</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">:</span>
                <span class="n">err_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to converge, maximum increase= &quot;</span>
                           <span class="s2">&quot;</span><span class="si">%.5e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_increase</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">NodeException</span><span class="p">(</span><span class="n">err_str</span><span class="p">)</span>

        <span class="c1"># if we land here, we have converged!</span>
        <span class="c1"># calculate output contrast</span>

        <span class="n">sfa</span><span class="p">,</span> <span class="n">ica</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_get_contrast</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">sfa</span><span class="o">+</span><span class="n">ica</span>
        <span class="c1"># print final information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fmt_prog_info</span><span class="p">(</span><span class="n">sweep</span><span class="p">,</span> <span class="n">perturbed</span><span class="p">,</span>
                                      <span class="n">contrast</span><span class="p">,</span> <span class="n">sfa</span><span class="p">,</span> <span class="n">ica</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_contrast</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SFA&#39;</span><span class="p">:</span> <span class="n">sfa</span><span class="p">,</span>
                               <span class="s1">&#39;ICA&#39;</span><span class="p">:</span> <span class="n">ica</span><span class="p">,</span>
                               <span class="s1">&#39;TOT&#39;</span><span class="p">:</span> <span class="n">sfa</span> <span class="o">+</span> <span class="n">ica</span><span class="p">}</span>

        <span class="c1"># finally return optimal rotation matrix</span>
        <span class="k">return</span> <span class="n">Q</span></div>

<div class="viewcode-block" id="ISFANode._do_sweep"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._do_sweep">[docs]</a>    <span class="k">def</span> <span class="nf">_do_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">prev_contrast</span><span class="p">):</span>
        <span class="c1"># perform a single sweep</span>

        <span class="c1"># initialize maximal improvement in a single sweep</span>
        <span class="n">max_increase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># shuffle rotation order</span>
        <span class="n">numx_rand</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rot_axis</span><span class="p">)</span>
        <span class="c1"># sweep through all axes combinations</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot_axis</span><span class="p">:</span>
            <span class="c1"># get the angle that minimizes the contrast</span>
            <span class="c1"># and the contrast value</span>
            <span class="n">angle</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_givens_angle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">covs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contrast</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># we hit numerical precision in case when b_sfa == 0</span>
                <span class="c1"># we can only break things from here on, better quit!</span>
                <span class="n">max_increase</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>

            <span class="c1"># relative improvement in the contrast function</span>
            <span class="n">relative_diff</span> <span class="o">=</span> <span class="n">old_div</span><span class="p">((</span><span class="n">prev_contrast</span><span class="o">-</span><span class="n">contrast</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">prev_contrast</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">relative_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if rate of change is negative we hit numerical precision</span>
                <span class="c1"># or we already sit on the optimum for this pair of axis.</span>
                <span class="c1"># don&#39;t rotate anymore and go to the next pair</span>
                <span class="k">continue</span>

            <span class="c1"># update the rotation matrix</span>
            <span class="n">rotate</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="c1"># rotate the covariance matrices</span>
            <span class="n">covs</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

            <span class="c1"># store maximum and previous rate of change</span>
            <span class="n">max_increase</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_increase</span><span class="p">,</span> <span class="n">relative_diff</span><span class="p">)</span>
            <span class="n">prev_contrast</span> <span class="o">=</span> <span class="n">contrast</span>

        <span class="k">return</span> <span class="n">max_increase</span><span class="p">,</span> <span class="n">covs</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">contrast</span></div>

<div class="viewcode-block" id="ISFANode._stop_training"><a class="viewcode-back" href="../../../node_list.html#mdp.nodes.ISFANode._stop_training">[docs]</a>    <span class="k">def</span> <span class="nf">_stop_training</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the training phase.</span>

<span class="sd">        If the node is used on large datasets it may be wise to first</span>
<span class="sd">        learn the covariance matrices, and then tune the parameters</span>
<span class="sd">        until a suitable parameter set has been found (learning the</span>
<span class="sd">        covariance matrices is the slowest part in this case).  This</span>
<span class="sd">        could be done for example in the following way (assuming the</span>
<span class="sd">        data is already white):</span>

<span class="sd">        &gt;&gt;&gt; covs=[mdp.utils.DelayCovarianceMatrix(dt, dtype=dtype)</span>
<span class="sd">        ...       for dt in lags]</span>
<span class="sd">        &gt;&gt;&gt; for block in data:</span>
<span class="sd">        ...     [covs[i].update(block) for i in range(len(lags))]</span>

<span class="sd">        You can then initialize the ISFANode with the desired parameters,</span>
<span class="sd">        do a fake training with some random data to set the internal</span>
<span class="sd">        node structure and then call stop_training with the stored covariance</span>
<span class="sd">        matrices. For example:</span>

<span class="sd">        &gt;&gt;&gt; isfa = ISFANode(lags, .....)</span>
<span class="sd">        &gt;&gt;&gt; x = mdp.numx_rand.random((100, input_dim)).astype(dtype)</span>
<span class="sd">        &gt;&gt;&gt; isfa.train(x)</span>
<span class="sd">        &gt;&gt;&gt; isfa.stop_training(covs=covs)</span>

<span class="sd">        This trick has been used in the paper to apply ISFA to surrogate</span>
<span class="sd">        matrices, i.e. covariance matrices that were not learnt on a</span>
<span class="sd">        real dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fix, whiten, symmetrize and weight the covariance matrices</span>
        <span class="c1"># the functions sets also the number of input components self.ncomp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix_covs</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span>
        <span class="c1"># if output_dim were not set, set it to be the number of input comps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span>
        <span class="c1"># adjust b_sfa and b_ica</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_ica_sfa_coeff</span><span class="p">()</span>
        <span class="c1"># initialize all possible rotation axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_axis</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effective_input_dim</span><span class="p">)]</span>

        <span class="c1"># initialize the global rotation-permutation matrix (RP):</span>
        <span class="n">RP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RP</span>
        <span class="k">if</span> <span class="n">RP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">RP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_eye</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># apply the global rotation matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">RP</span><span class="p">)</span>

        <span class="c1"># find optimal rotation</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize</span><span class="p">()</span>
        <span class="n">RP</span> <span class="o">=</span> <span class="n">mult</span><span class="p">(</span><span class="n">RP</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
        <span class="c1"># rotate and permute the covariance matrices</span>
        <span class="c1"># we do it here in one step, to avoid the cumulative errors</span>
        <span class="c1"># of multiple rotations in _optimize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>

        <span class="c1"># keep the complete rotation-permutation matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RPC</span> <span class="o">=</span> <span class="n">RP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Reduce dimension to match output_dim#</span>
        <span class="n">RP</span> <span class="o">=</span> <span class="n">RP</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">]</span>
        <span class="c1"># the variance for the derivative of a whitened signal is</span>
        <span class="c1"># 0 &lt;= v &lt;= 4, therefore the diagonal elements of the delayed</span>
        <span class="c1"># covariance matrice with time lag = 1 (covs[:,:,0]) are</span>
        <span class="c1"># -1 &lt;= v&#39; &lt;= +1</span>
        <span class="c1"># reorder the components to have them ordered by slowness</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covs</span><span class="o">.</span><span class="n">covs</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RP</span> <span class="o">=</span> <span class="n">RP</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

        <span class="c1"># we could in principle clean up self.covs, as we do in SFANode or</span>
        <span class="c1"># PCANode, but this algorithm is not stable enough to rule out</span>
        <span class="c1"># possible problems. When these occcurs examining the covariance</span>
        <span class="c1"># matrices is often the only way to debug.</span>
        <span class="c1">#del self.covs</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
      Last updated on 2020-02-17 1:33:02 PM Coordinated Universal Time.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'3.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   
<div class="footer">
    <hr />
    <table>
      <tr>
        <td class="footer-left">
           <a href="http://sourceforge.net/projects/mdp-toolkit">
 <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=116959&amp;type=12"
      width="120" height="30" border="0" alt="MDP@SF.NET"/> </a>
        </td>
        <td class="footer-center">
          Last updated on
             2020-02-17 1:33:02 PM Coordinated Universal Time
        </td>
        <td class="footer-right">
         <form class="search" action="../../../search.html" method="get">
          <input type="submit" value="Search" />
          <input type="text" name="q" size="18" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
         </form>
        </td>
    </table>  
    <!-- Piwik -->
    <script type="text/javascript">
	var pkBaseURL = (("https:" == document.location.protocol) ? "https://sourceforge.net/apps/piwik/mdp-toolkit/" : "http://sourceforge.net/apps/piwik/mdp-toolkit/");
	document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
	piwik_action_name = '';
	piwik_idsite = 1;
	piwik_url = pkBaseURL + "piwik.php";
	piwik_log(piwik_action_name, piwik_idsite, piwik_url);
    </script>
    <object><noscript>
	    <p>
		<img src="http://sourceforge.net/apps/piwik/mdp-toolkit/piwik.php?idsite=1"
		     alt="piwik" />
	    </p>
    </noscript></object>
    <!-- End Piwik Tag -->
</div>   


</body>
</html>